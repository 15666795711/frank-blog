---
title: 深入理解HTTPS协议
date: 2024-03-25 14:30:35
tags: [HTTPS, TLS, SSL, 前端安全]
---

## 前言

上一片文章我们讨论了[HTTP 协议](/frank-blog/2024/03/24/深入理解HTTP协议/)的相关知识，本篇文章我们来讨论下 HTTPS 的相关知识。

不知道大家在日常开发过程中有没有这种疑问：

1. HTTP 协议为什么安全？
2. HTTPS 与 HTTP 的区别是什么？
3. 都说 HTTPS 安全，它是如何做到安全的，它具体的执行过程是怎样的？

那这篇文章就带大家一起探讨一下这三个问题。

## 正文

### HTTP 协议为什么不安全

这个问题其实很好理解，我们都知道 HTTP 是通过明文进行传输的，传输过程中没有任何的安全防护措施，因此，我们可以在数据传输的任何过程中进行拦截，那我们就能拿到传输的数据信息。

![](/images/https-4.png)

### HTTPS 与 HTTP 的区别是什么

大家还记得我们在[深入理解 HTTP 协议](/frank-blog/2024/03/24/深入理解HTTP协议/)中提到的 OSI 模型吧，我们来回顾一下：

![](/images/http-01.png)

那其实 HTTPS 协议就是在应用层和传输层中间添加了一层安全层，也就是一套安全协议：

![](/images/https-1.png)

这样 HTTP 请求在通往 TCP 请求时都需要经过 TLS/SSL 协议进行加密，这样我们直观就会感觉它有了一层安全的保障。

但是我们还想继续探究它在这个过程中具体做了什么，使得原本不安全的请求变得安全的。

### HTTPS 是如何做到安全的

我们在[深入理解 HTTP 协议](/frank-blog/2024/03/24/深入理解HTTP协议/)中了解到客户端在与服务端建立通信的时候需要经过 TCP 的三次握手，成功后就可以进行正常的通信了。

那么我们要做的事情也就明确了，我们需要在通信成功建立之前，TCP 三次握手之后进行安全加密。

主要过程分为以下几个阶段：

1. **客户端与服务器建立连接：**

   - 客户端向服务器发起 HTTPS 请求，通过 TCP 三次握手进行连接，通常连接到服务器的 443 端口。
   - 客户端向服务端发送支持的加密套件
   - 服务器响应客户端，提供其 CA 数字证书（包含公钥）以及其他必要的握手信息。

2. **密钥协商：**

   - 客户端验证服务器 CA 证书
   - 客户端生成随机数：客户端生成一个随机数，这个随机数将作为后续通信的会话密钥（非对称密钥）。
   - 公钥加密：客户端使用服务器提供的公钥，将这个会话密钥（非对称密钥）加密。
   - 密钥传输：客户端将加密后的会话密钥发送给服务器。

3. **服务器解密：**

   - 私钥解密：服务器接收到加密的会话密钥后，使用与公钥对应的私钥进行解密。
   - 密钥确认：服务器解密得到与客户端相同的会话密钥。

至此，客户端和服务端都拥有了同一份会话密钥。这个会话密钥是由客户端生成的，并通过非对称加密（如 RSA 或 ECC）机制安全地传递给了服务器。一旦双方都获得了这个非对称密钥，它们就可以开始使用该密钥及选定的加密套件，通常是对称加密算法（如 AES、DES 或 3DES）来加密和解密后续的会话数据，确保通信内容的保密性和完整性。

整个过程如下图：

![](/images/https-2.png)

那看到这里有的同学就要问了：**那你怎么能保证这个 CA 证书不是伪造的或者被黑客截取呢？** 我们一个一个来看。

**CA 证书能否被伪造**

我们首先需要知道 CA 证书是如何颁发的，是由什么机构颁发的。详细的过程如下，因为主要是运维和服务端同学的工作，前端不涉及，所以大家感兴趣可以看一下，不敢兴趣可以略过，我在最后做一个简单的总结。

- **选择合适的证书类型：**

  - 根据您的需求，确定需要申请哪种类型的 CA 证书。常见的证书类型包括：
    SSL/TLS 证书（Secure Sockets Layer / Transport Layer Security）： - 域名验证型（DV）证书：仅验证域名所有权，适合个人网站或小型企业，验证快速，一般几分钟内即可完成。 - 组织验证型（OV）证书：除了验证域名所有权外，还验证申请者的组织信息，如公司名称、地址等，提供更高的信任度，适用于企业级网站。 - 扩展验证型（EV）证书：除 DV 和 OV 的验证外，还包括更严格的身份验证，如法律实体验证、电话验证等。EV 证书在浏览器地址栏显示绿色公司名称，提供最高级别的可信度，适用于金融机构、电子商务平台等对安全性要求极高的网站。
  - 代码签名证书：用于对软件代码进行数字签名，确保代码的完整性和来源可信，适用于软件开发商。
  - 文档签名证书：用于对电子文档（如 PDF）进行数字签名，保证文档的完整性和签署人的身份真实性。
  - IP 证书：针对 IP 地址颁发的 SSL 证书，用于保护通过 IP 地址访问的网站。

- **生成 CSR（Certificate Signing Request）文件：**

  使用专用工具（如 OpenSSL）或通过 Web 主机控制面板、CA 机构提供的在线工具生成 CSR 文件。CSR 文件中包含了申请者信息（如组织名、域名、联系信息等）以及公钥。同时，系统会生成一对密钥（公钥和私钥），私钥应妥善保管，用于后续安装证书时解密由 CA 颁发的证书。

- **提交申请：**

  将生成的 CSR 文件提交给选定的 CA 机构。提交方式可能包括直接上传到 CA 网站、通过电子邮件发送或通过 API 接口提交。同时，根据所选证书类型，可能需要提供额外的验证材料，如组织注册证明、法人代表身份证明、DNS 记录验证等。

- **验证申请信息：**

  CA 机构会对提交的申请信息进行验证。对于 DV 证书，主要是通过域名控制权验证（如 DNS TXT 记录、邮箱验证等）；对于 OV 和 EV 证书，还需要验证组织信息，可能涉及人工审核、电话或书面确认等步骤。

- **审核通过与颁发证书：**

  验证通过后，CA 机构会签发相应的数字证书。证书通常以 PEM 或 DER 格式提供，包含了 CA 的签名、申请者的公钥以及证书的相关元数据。

  对于 DV 证书，颁发过程可能非常快，几分钟到几小时内即可完成；而对于 OV 和 EV 证书，由于涉及更严格的验证，颁发时间可能需要 3 到 7 个工作日。

- **安装与配置证书：**

  收到 CA 颁发的证书后，将其 `服务器证书` 安装到服务器（如 Web 服务器、邮件服务器等）的适当位置，将 `根证书` 安装到客户端（如浏览器、操作系统、移动设备等），并配置服务器软件（如 Apache、Nginx、IIS 等）以启用 HTTPS 或相应服务的加密功能。同时，确保将私钥安全地部署到服务器。

- **续期与管理：**

  CA 证书具有有效期，通常为 1 年至 3 年不等。临近证书到期时，需提前进行续期操作，避免因证书过期导致服务中断。保持关注 CA 发布的更新通知，及时应对可能的安全漏洞或算法升级。

简单来说，`CA证书是由运维和后端同学向权威的CA机构进行层层申请获得的，所以说CA证书是不能被伪造的。`

**CA 证书能否被拦截**

我们在上面提到的，`CA根证书` 会被放在客户端，并不会在通信中作为数据传输，所以是不会被拦截到的。`CA服务器证书` 会被放在服务端，会被发送给客户端进行验证，这个过程中可能会被拦截，不过 TLS/SSL 协议也对这个过程做了加密处理，保证这个过程的安全性。

## 后序

所谓魔高一尺，道高一丈。在真实的网络环境中是不存在百分百安全的，我们只能通过不断的加强完全措施来应对出现的安全问题。
